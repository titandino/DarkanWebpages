<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" charset="utf-8"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>

<div class="skill-icons panel-body col-xs-12" style="text-align:center">
  <a class="Skill" title="total" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Overall-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Attack" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Attack-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Defence" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Defence-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Strength" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Strength-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Hitpoints" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Hitpoints-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Ranged" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Ranged-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Prayer" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Prayer-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Magic" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Magic-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Cooking" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Cooking-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Woodcutting" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Woodcutting-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Fletching" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Fletching-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Fishing" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Fishing-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Firemaking" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Firemaking-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Crafting" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Crafting-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Smithing" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Smithing-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Mining" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Mining-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Herblore" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Herblore-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Agility" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Agility-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Thieving" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Thieving-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Slayer" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Slayer-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Farming" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Farming-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Runecrafting" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Runecrafting-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Hunter" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Hunter-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Construction" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Construction-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Summoning" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Summoning-icon.png" class="skill-icon"></a>
  <a class="Skill" title="Dungeoneering" data-toggle="tooltip" data-placement="top"><img src="assets/images/skill_icons/Dungeoneering-icon.png" class="skill-icon"></a>
</div>

<h4 id="nowViewing" class="text-center col-xs-12"></h4>

<input id="viewSkill" type="hidden" value='total'></input>

<div id="hs-options" class="col-xs-12 col-md-3 pull-right">
  <div class="col-xs-12 hs-option-group">
    <span>Gamemode:</span>
    <select id="ironman" class="form-control col-xs-12">
      <option value="all" selected="selected">All</option>
      <option value="0">Normal</option>
      <option value="1">Ironman</option>
    </select>
  </div>

  <div class="col-xs-12 hs-option-group">
    <span>XP Mode:</span>
    <select id="xpmode" class="form-control col-xs-12">
      <option value="all" selected="selected">All</option>
      <option value="0">x25</option>
      <option value="1">x10</option>
      <option value="2">x1</option>
    </select>
  </div>

  <div class="col-xs-12 hs-option-group">
    <span>Search user:</span>
    <input id="hsusername" class="form-control col-xs-12" type="text" name="Username" value="">
    <button class="hssearch-button form-control col-xs-12" type="button" name="button">Search</button>
  </div>
</div>

<div id="hs-table-container" class="col-xs-12 col-md-9">
  <table id="hs-table" class="table table-striped">
    <thead>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<div id="user-table-container" class="col-xs-12 col-md-9">
  <table id="user-table" class="table table-striped">
    <thead>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
(function() {
  const SKILL_NAMES = ["Attack", "Defence", "Strength", "Constitution", "Ranged", "Prayer", "Magic", "Cooking", "Woodcutting", "Fletching", "Fishing", "Firemaking", "Crafting", "Smithing", "Mining", "Herblore", "Agility", "Thieving", "Slayer", "Farming", "Runecrafting", "Hunter", "Construction", "Summoning", "Dungeoneering"];

  $('.skill-icons a').on('click', function() {
    let skill = $(this).attr('title');
    $('#viewSkill').val(skill);
    populate();
  })

  function getSkillIdx(skill) {
    for (let i = 0;i < SKILL_NAMES.length;i++) {
      if (SKILL_NAMES[i].toLowerCase() == skill.toLowerCase())
      return i;
    }
    return 0;
  }

  function formatTitle(title) {
    var finalTitle = '';
    if (title) {
      finalTitle = title;
      finalTitle = finalTitle.replace(new RegExp('<shad=000000>', 'g'), '');
      finalTitle = finalTitle.replace(new RegExp('</shad>', 'g'), '');
      finalTitle = finalTitle.replace(new RegExp('<col=', 'g'), '<span style="color: #');
      finalTitle = finalTitle.replace(new RegExp('</col>', 'g'), '</span>');
      finalTitle = finalTitle.replace(new RegExp('>', 'g'), ';">');
      finalTitle = finalTitle.replace(new RegExp('</span;">', 'g'), '</span>');
      finalTitle += "</span> ";
    }
    return finalTitle;
  }

  function upperFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1)
  }

  function searchUser() {
    let username = $('#hsusername').val();
    $.getJSON('http://darkan.org:5556/api/player/'+username.replace(/ /g,"_"), function(data) {
      if (data) {
        $('#hs-table-container').hide();
        $('#user-table-container').show();
        $('#nowViewing').html(formatTitle(data.title) + upperFirst(username));
        $('#user-table tbody').empty();
        $('#user-table thead').empty();
        $('#user-table thead').append('<tr><th>Skill</th><th>Level</th><th>Experience</th></tr>');
        $('#user-table tbody').append('<tr><td><img src="assets/images/skill_icons/Overall-icon.png" class="skill-icon">Total</td><td>'+data.stats.totalLevel.toLocaleString()+'</td><td>'+data.stats.totalXp.toLocaleString()+'</td></tr>');
        for (let i = 0;i < data.stats.skills.length;i++) {
          $('#user-table tbody').append('<tr><td><img src="assets/images/skill_icons/'+SKILL_NAMES[i]+'-icon.png" class="skill-icon">'+SKILL_NAMES[i]+'</td><td>'+data.stats.skills[i].level.toLocaleString()+'</td><td>'+data.stats.skills[i].xp.toLocaleString()+'</td></tr>');
        }
      } else {
        console.log('User not found.');
      }
    })
  }

  function resetTable() {
    $('#hs-table tbody').empty();
    $('#hs-table thead').empty();
    $('#hs-table thead').append('<tr><th>Rank</th><th>Name</th><th>Level</th><th>Experience</th></tr>');
  }

  function getColor(type) {
    if (type == 1)
      return 'style="text-shadow:2px 2px 5px green;"';
    if (type == 2)
      return 'style="text-shadow:2px 2px 5px red;"';
    return '';
  }

  function getPrefix(ironman) {
    let prefix = '';
    if (ironman) {
      prefix += '<img src="https://i.imgur.com/QPvgyhy.png">'
    }
    return prefix;
  }

  function populate() {
    $('#user-table-container').hide();
    $('#hs-table-container').show();
    let skill = $('#viewSkill').val();
    let xpmode = $('#xpmode option:selected').val();
    let accountStatus =  $('#ironman option:selected').val();

    resetTable();
    let query = '&xpmode=' + xpmode
    query += '&ironman=' + accountStatus;

    $('#nowViewing').text(skill == 'total' ? 'Overall' : upperFirst(skill));
    $.getJSON('http://darkan.org:5556/api/highscores/?skill='+skill+query, function(data) {
      console.log(data);
      for (let i = 0;i < data.length;i++) {
        if (skill == 'total')
          $('#hs-table tbody').append('<tr><td>'+(i+1)+'</td><td '+getColor(data[i].accountType)+'>'+getPrefix(data[i].ironman)+' '+data[i].displayName+'</td><td>'+data[i].totalLevel.toLocaleString()+'</td><td>'+data[i].totalXp.toLocaleString()+'</td></tr>');
        else
          $('#hs-table tbody').append('<tr><td>'+(i+1)+'</td><td '+getColor(data[i].accountType)+'>'+getPrefix(data[i].ironman)+' '+data[i].displayName+'</td><td>'+data[i].level[getSkillIdx(skill)].toLocaleString()+'</td><td>'+data[i].xp[getSkillIdx(skill)].toLocaleString()+'</td></tr>');
      }
    });
  }

  $('select').change(populate);
  $('.hssearch-button').on('click', searchUser);
  populate();
})();
</script>
